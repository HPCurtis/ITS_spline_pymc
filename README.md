# Interrupted timseries analysis (ITS) using Restricted Cubic Splines (RCS) in PyMC

## Overview 
This repo contains a Bayesian workflow example of an ITS analysis based on Bernal, Cummins, Gasparrini, (2017) tutorial using data from Barone-Adesi et al . (2011) and some advanced modelling options inspired by similar analysis from chapter two of Frank Harrells' wonderful [Regression Modeling Strategies](https://hbiostat.org/rmsc/) textbook. Specifically, the use of RCS Devlin & Weeks (1986) and cyclic trends to capture nonlinearity and seasonality due to the timeseries nature of the data whilst estimating a causal effect using an ITS analysis methodology (Bhaskaran et al. 2013).  

Causal models using ITS can be easily estimated using Python/PyMC. Prepackaged examples are available in the form provided CausalPy, one of PyMC's ever-developing extension packages (Abril-Pla et al., 2023). Currently, however, the model syntax is limited and focuses on using prediction-based methods (this is likely due to the design choice of CausalPy to also support Scikit-learn forms of the models) to determine and visualise the causal effects similar to those generated by the R-based CausalImpact package (Brodersen et al. 2017). 

However, the following analysis provides a Bayesian version to the tutorial analysis presented by Bernal et al., and as such, the focus here is on the statistical estimation of a causal estimand Lundberg et al. (2021), specifcally the risk ratio difference between pre and post-intervention.

## File structure
- README.md: The file your reading right now.
- its.ipynb: Jupyter notebook containing the python code for the analysis of the dataset.
- its.pdf: pdf form of ipython notebook.
- model.py: python file containing the Posoon regression PyMC model code used in the its.ipynb notebook.
- utils.py: python file of variosu utility fucntionf or the anlaysis used in the its.ipynb notebook. The file contains eh code for generation of the RCS splines cyclical model components and Risk Ration calculations.
- vis 
  - ACE_scatter.png: PNG file plot showing the ACE rate for sicily between 2002-2006.
  - rcs_fit.png: PNG file fro model fit for RCS model. 
  - cyl_fit.png: PNG file fro model fit for RCS + Cyl model.
  - PPC_rcs.png: PNG file showing the posterior predictive plots produced by the arviz package for RCS model
  - PPC_cyl.png: PNG file showing the posterior predictive plots produced by the arviz package for RCS + Cyl model.
  - rank_rcs.png: PNG file showing the rank plots for MCMC chains produced by the arviz package for RCS model.
  - rank_cyl.png: PNG file showing the rank plots for MCMC chains produced by the arviz package for RCS + Cyl model.
  - loo_comparison.png: PNG file contianing a plot showing the outcome of LOO-Cv mdoel comparsion for RCS and RCS + Cyl models.


# References

Abril-Pla, O., Andreani, V., Carroll, C., Dong, L., Fonnesbeck, C. J., Kochurov, M., ... & Zinkov, R. (2023). PyMC: a modern, and comprehensive probabilistic programming framework in Python. PeerJ Computer Science, 9, e1516.

Barone-Adesi, F., Gasparrini, A., Vizzini, L., Merletti, F., & Richiardi, L. (2011). Effects of Italian smoking regulation on rates of hospital admission for acute coronary events: a country-wide study. PloS one, 6(3), e17419.

Bernal, J. L., Cummins, S., & Gasparrini, A. (2017). Interrupted time series regression for the evaluation of public health interventions: a tutorial. International journal of epidemiology, 46(1), 348-355.

Bhaskaran, K., Gasparrini, A., Hajat, S., Smeeth, L., & Armstrong, B. (2013). Time series regression studies in environmental epidemiology. International journal of epidemiology, 42(4), 1187-1195.

Brodersen, K. H., Hauser, A., & Hauser, M. A. (2017). Package CausalImpact. Google LLC: Mountain View, CA, USA.

Lundberg, I., Johnson, R., & Stewart, B. M. (2021). What is your estimand? Defining the target quantity connects statistical evidence to theory. American Sociological Review, 86(3), 532-565.


McElreath R. Statistical Rethinking. 2nd Edition. London (UK): Routledge; 2020.

Devlin, T. F., & Weeks, B. J. (1986). Spline functions for logistic regression modeling. Proceedings of the Eleventh Annual SAS Users Group International Conference, 646â€“651.

# Web resources
https://hbiostat.org/rmsc/

https://github.com/harrelfe/Hmisc